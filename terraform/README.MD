## Introduction

This directory contains the [Terraform](https://www.terraform.io/) files to spin up a simple IOMETE environment in Azure. For now, the scripts only
support Azure and AWS or GCP.

## Environment setup

### Required tools

To run this on your local machine, you will need the following CLI tools installed:
* [kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl)
* [azure cli](https://learn.microsoft.com/en-us/cli/azure/?view=azure-cli-latest)
* [terraform cli](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)

For those running on MacOS, using [homebrew](https://brew.sh/) you can run below commands to install:
```shell
brew update && brew upgrade
brew install kubernetes-cli
brew install terraform
brew install az
```

### Configuring Azure storage backend

When not using [Terraform cloud](https://app.terraform.io/session) or [Terraform Enterprise](https://developer.hashicorp.com/terraform/enterprise), terraform state can also be stored directly in Azure.
This will require a [storage account](https://learn.microsoft.com/en-us/azure/storage/common/storage-account-overview) and a storage container. 

The commands below help create those:
```shell
# this example creates the storage account in germany west. 
# make sure you have a resource group created, here we assume Azure resource group `terraform-state-rg` exists
az storage account create \
    --name iomete \
    --resource-group terraform-state-rg \
    --location germanywestcentral \
    --sku Standard_LRS \
    --kind StorageV2 \
    --allow-blob-public-access false

# configures the storage container in the account
az storage container create \
    --name tfstate \
    --account-name iomete
```

## Creating a new IOMETE environment

### Installing IOMETE

In file [variables.tf](), you will need to provide a number of values to initialize iomete:
* your [Azure subscription id](https://learn.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id)
* your [Azure tenant id](https://learn.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id)
* the resource group name for the terraform state (`terraform-state-rg` in previous steps' example)
* the storage account name for the terraform state (`iomete` in previous steps' example)
* the storage container name for the terraform state (`tfstate` in previous steps' example)

Once the storage backend has been set up and all CLI tools have been installed, we can initialize terraform: 
```shell
terraform init --upgrade
```

Now, let's examine the Terraform plan. This outputs what Terraform expects to do
```shell
terraform plan
```

Once we think the plan looks good, we can apply the plan. Since we already looked at the plan in the above step,
we add the `--auto-approve` flag to signal to Terraform it can go ahead and install the components.
```shell
terraform apply --auto-approve
```

### Testing IOMETE

With the environment installed, we can now login to try it out. Our base Terraform here doesn't automatically add a 
DNS entry or routing. This is left up to the user as this will specific to each companies polices and setup. For 
simple testing here, we can use kubernetes port-forwarding. Below example assumes you have set the newly created
Azure AKS cluster as your default context in `kubectl`.

```shell
kubectl port-forward service/iom-gateway -n iomete-system 12345:80
```

The passwords are auto generated by Terraform as well. To see a particular password, we can run below Terraform command
```shell
 terraform output iomete_console_admin_password
```

All other sensitive outputs can be found in the outputs.tf file.


### Tearing down the environment

To remove the entire installation, you can run:

```shell
terraform destroy --auto-approve
```

In case of issues or terraform not being able to correcly spin down the environment, you can always choose
to remove the entire resource-group from Azure.
